<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Analysis Results - AI Design Assistant</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Agbalumo&family=Artifika:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* è‰²å½©ç³»ç»Ÿ - åŸºäºæŸ”å’Œç²‰è‰²ï¼Œç¡®ä¿WCAGå¯¹æ¯”åº¦ */
            --primary-pink: #F5E6E8;
            --primary-pink-dark: #E8D1D5;
            --primary-pink-darker: #D4B8BD;
            --accent-pink: #F0D6DA;
            --text-primary: #2D1B1D;
            --text-secondary: #5A4A4C;
            --text-tertiary: #8A7A7C;
            --background-gradient: linear-gradient(135deg, #F5E6E8 0%, #F9F1F2 50%, #FDF7F8 100%);
            --card-background: rgba(255, 255, 255, 0.8);
            --shadow-soft: 0 4px 20px rgba(245, 230, 232, 0.3);
            --shadow-hover: 0 8px 30px rgba(245, 230, 232, 0.4);
            --border-radius: 16px;
            --border-radius-large: 24px;
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 48px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Artifika', serif;
            background: white;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* iPhone 16 Pro Max å°ºå¯¸ä¼˜åŒ– */
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: 
                radial-gradient(ellipse at top right, #FEFBEF 0%, transparent 50%),
                linear-gradient(180deg, #F5E6E8 0%, #F9F1F2 30%, #FDF7F8 50%, #EFF6FF 100%);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Header ç»„ä»¶ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-sm);
            border-bottom: 1px solid rgba(123, 90, 89, 0.1);
            box-shadow: 0 2px 8px rgba(123, 90, 89, 0.1);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .back-button {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .back-button:hover {
            transform: translateX(-2px);
        }

        .back-icon {
            width: 24px;
            height: 24px;
            filter: brightness(0) saturate(100%) invert(45%) sepia(15%) saturate(800%) hue-rotate(320deg) brightness(90%) contrast(85%);
        }

        .header-title {
            font-family: 'Agbalumo', cursive;
            font-size: 18px;
            color: var(--text-primary);
            font-weight: 500;
            flex: 1;
            text-align: left;
            margin: 0;
            margin-left: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            width: 60px;
            justify-content: flex-end;
        }

        .icon-button {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .icon-button:hover {
            background: transparent;
            transform: translateY(-1px);
        }

        .icon-button:active {
            transform: translateY(0);
            background: transparent;
        }

        .header-icon {
            width: 31px;
            height: 31px;
            object-fit: cover;
            border-radius: 50%;
        }

        .notification-icon {
            width: 23px;
            height: 26px;
            object-fit: contain;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            padding: var(--spacing-lg) var(--spacing-md);
            padding-bottom: 220px;
            min-height: calc(100vh - 80px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-section {
            width: 100%;
            max-width: 398px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .message {
            display: flex;
            gap: var(--spacing-sm);
            max-width: 100%;
            animation: fadeInUp 0.5s ease-out;
        }

        .user-message {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .ai-message {
            flex-direction: row;
            align-self: flex-start;
        }

        .message-avatar {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-pink);
        }

        .ai-avatar-img, .user-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            max-width: calc(100% - 50px);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .message-text {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .user-message .message-text {
            background: linear-gradient(135deg, #F5E6E8, #F0D6DA);
            color: var(--text-primary);
            border-bottom-right-radius: 6px;
        }

        .ai-message .message-text {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-primary);
            border: 1px solid rgba(245, 230, 232, 0.3);
            border-bottom-left-radius: 6px;
            backdrop-filter: blur(10px);
        }
        
        /* AIå¼•å¯¼åŒºåŸŸ */
        .ai-guidance-section {
            margin-bottom: var(--spacing-md);
            width: 100%;
            max-width: 398px;
        }
        
        .guidance-bubble {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(245, 230, 232, 0.3);
            border-radius: var(--border-radius);
            border-bottom-left-radius: 6px;
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.4;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
        }
        
        /* åˆ†æç»“æœå¡ç‰‡æ ·å¼ */
        .analysis-result {
            background: linear-gradient(135deg, #F8E8EA, #F5E0E2);
            border: 2px solid #E8D1D5;
            border-radius: var(--border-radius-large);
            padding: var(--spacing-md);
            margin: 0 auto;
            color: white;
            text-align: center;
            width: 350px;
            min-height: 400px;
            max-height: 800px;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }
        
        .analysis-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            font-family: 'Artifika', serif;
            color: var(--text-primary);
        }
        
        .analysis-date {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }
        
        .analysis-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            overflow: visible;
        }
        
        .analysis-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #F0D6DA;
            border-radius: var(--border-radius);
            padding: 12px;
            color: var(--text-primary);
            text-align: left;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-height: 100px;
            height: auto;
            overflow: visible;
            word-wrap: break-word;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'Artifika', serif;
        }
        
        .difficulty-score {
            font-size: 36px;
            font-weight: bold;
            color: #FF6B9D;
            min-width: 60px;
            text-align: center;
            line-height: 1;
        }
        
        .card-content {
            font-size: 11px;
            line-height: 1.3;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 11px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .cost-total {
            font-weight: 600;
            color: var(--text-primary);
            border-top: 1px solid rgba(245, 230, 232, 0.6);
            padding-top: 6px;
            margin-top: 6px;
            font-size: 11px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .suggestion-item {
            margin-bottom: 6px;
            font-size: 11px;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-tertiary);
            text-align: right;
            margin-top: var(--spacing-xs);
        }

        .user-message .message-time {
            text-align: left;
        }

        /* åŠ è½½çŠ¶æ€ */
        .ai-thinking {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            border-bottom-left-radius: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(245, 230, 232, 0.3);
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: thinking 1.4s ease-in-out infinite both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinking {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* é”™è¯¯çŠ¶æ€ */
        .error-message {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            margin: var(--spacing-sm) 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        /* æ¶ˆæ¯ä¸­çš„å›¾ç‰‡ */
        .message-images {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .message-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(245, 230, 232, 0.6);
        }
        
        .message-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        
        /* æ·»åŠ æ›´å¤šç…§ç‰‡çš„å°æ¡† */
        .add-more-image {
            width: 60px;
            height: 60px;
            border: 2px dashed #F0D6DA;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .add-more-image:hover {
            border-color: #E8D1D5;
            background: rgba(245, 230, 232, 0.3);
            transform: scale(1.05);
        }
        
        .add-more-icon {
            width: 20px;
            height: 20px;
            opacity: 0.6;
        }
        
        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .input-section {
            position: fixed;
            bottom: 110px; /* åœ¨å¯¼èˆªæ ä¸Šæ–¹ */
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 398px;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .input-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius-large);
            padding: var(--spacing-sm) var(--spacing-md);
            box-shadow: 0 4px 20px rgba(245, 230, 232, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px);
        }
        
        .message-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
            font-family: 'Artifika', serif;
        }
        
        .message-input::placeholder {
            color: var(--text-tertiary);
        }
        
        .send-button {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: linear-gradient(135deg, #F5E6E8, #F0D6DA);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(245, 230, 232, 0.4);
        }
        
        .send-button.active {
            background: linear-gradient(135deg, #FFB6C1, #FFC0CB);
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.4);
        }
        
        .send-button:hover {
            transform: scale(1.05);
        }
        
        .send-button svg {
            fill: #7B5A59;
            width: 16px;
            height: 16px;
            transform: rotate(-145deg);
        }
        
        /* æ“ä½œæŒ‰é’®åŒºåŸŸ */
        .action-buttons {
            width: 100%;
            padding: var(--spacing-lg) 0;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            gap: var(--spacing-md);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .action-buttons.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* ç¬¬ä¸€è¡ŒæŒ‰é’® */
        .action-button-row {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        
        /* ç¬¬äºŒè¡ŒæŒ‰é’® */
        .action-button-row.second-row {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
        }
        
        .action-button {
            height: 48px;
            border: 2px solid #FFC9C7;
            border-radius: var(--border-radius-large);
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-primary);
            font-size: 11px;
            font-weight: 500;
            font-family: 'Artifika', serif;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(255, 201, 199, 0.2);
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
        }
        
        /* ç¬¬ä¸€è¡ŒæŒ‰é’®æ ·å¼ - æ·¡ç²‰è‰² */
        .action-button.primary {
            width: 280px;
            background: linear-gradient(135deg, #FFE4E6, #FFF0F1);
            border-color: #FFB6C1;
        }
        
        /* ç¬¬äºŒè¡ŒæŒ‰é’®æ ·å¼ */
        .action-button.secondary {
            width: 130px;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 201, 199, 0.3);
        }
        
        .action-button:active {
            transform: translateY(0);
        }
        
        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 440px;
            height: 94px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, rgba(245, 230, 232, 0.3) 100%);
            backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0;
            padding: var(--spacing-md) 0 var(--spacing-sm);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(245, 230, 232, 0.2);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: var(--spacing-xs);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 80px;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(245, 230, 232, 0.3);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: rgba(245, 230, 232, 0.6);
            transform: translateY(-2px);
        }

        .nav-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            object-fit: cover;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: brightness(0) saturate(100%) invert(45%) sepia(8%) saturate(1200%) hue-rotate(315deg) brightness(95%) contrast(88%);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.15);
        }

        .nav-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-item.active .nav-label {
            color: var(--text-primary);
        }
        
        .action-button-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }
        
        /* Heart icon æ ·å¼ */
        .heart-icon {
            width: 16px;
            height: 16px;
            fill: #ff6b9d;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 430px) {
            .app-container {
                max-width: 100%;
            }
            
            .main-content {
                padding: var(--spacing-md) var(--spacing-sm);
                padding-bottom: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <button class="icon-button back-button" onclick="goBack()" aria-label="Back">
                    <img src="è®¾è®¡å›¾/è¿”å›é”®Icon.svg" alt="Back" class="back-icon">
                </button>
            </div>
            <h1 class="header-title">Garment analyse</h1>
            <div class="header-actions">
                <button class="icon-button" aria-label="Notifications">
                    <img src="è®¾è®¡å›¾/é€šçŸ¥icon2.png" alt="Notifications" class="notification-icon">
                </button>
                <button class="icon-button" aria-label="User Profile">
                    <img src="è®¾è®¡å›¾/æˆ‘çš„å¤´åƒ.png" alt="User" class="header-icon">
                </button>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="main-content">
            <section class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be added here dynamically -->
                </div>
                
                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ - æ”¾åœ¨èŠå¤©æ¶ˆæ¯åé¢ -->
                <div class="action-buttons" id="actionButtons">
                    <!-- ç¬¬ä¸€è¡Œï¼šEnter Inspiration collect -->
                    <div class="action-button-row">
                        <button class="action-button primary" onclick="enterInspirationCollect()">
                            <img src="è®¾è®¡å›¾/Inspiration icon.png" alt="Inspiration" class="action-button-icon">
                            Enter Inspiration collect
                        </button>
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œï¼šCollect result å’Œ Find suppliers -->
                    <div class="action-button-row second-row">
                        <button class="action-button secondary" onclick="collectResult()">
                            <svg class="heart-icon" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            Collect result
                        </button>
                        <button class="action-button secondary" onclick="findSuppliers()">
                            <img src="è®¾è®¡å›¾/Supplier icon.png" alt="Suppliers" class="action-button-icon">
                            Find suppliers
                        </button>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
        <section class="input-section">
            <div class="input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="Continue the conversation...">
                <button class="send-button" id="sendButton" onclick="sendFollowUpMessage()">
                    <svg viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </section>
        
        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navigateToHome()">
                <img src="è®¾è®¡å›¾/home icon.png" alt="Home" class="nav-icon">
                <span class="nav-label">Home</span>
            </div>
            <div class="nav-item" onclick="navigateToInspiration()">
                <img src="è®¾è®¡å›¾/Inspiration icon.png" alt="Inspiration" class="nav-icon">
                <span class="nav-label">Inspiration</span>
            </div>
            <div class="nav-item" onclick="navigateToSupplier()">
                <img src="è®¾è®¡å›¾/Supplier icon.png" alt="Supplier" class="nav-icon">
                <span class="nav-label">Supplier</span>
            </div>
            <div class="nav-item" onclick="navigateToAccount()">
                <img src="è®¾è®¡å›¾/Account icon.png" alt="Account" class="nav-icon">
                <span class="nav-label">Account</span>
            </div>
        </nav>
    </div>

    <script>
        // Pattern Risk Analysis API URL
        const PATTERN_ANALYSIS_API_URL = 'https://lynn-cafa-system.app.n8n.cloud/webhook/api/pattern-risk-analysis';
        
        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            window.location.href = 'æ‰“ç‰ˆåˆ†æ.html';
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(message, images = []) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            let imagesHtml = '';
            if (images && images.length > 0) {
                imagesHtml = '<div class="message-images">';
                images.forEach(image => {
                    if (image.type === 'file') {
                        imagesHtml += `<div class="message-image" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:10px;">ğŸ“„</div>`;
                    } else {
                        imagesHtml += `<div class="message-image"><img src="${image.data}" alt="${image.name}" onclick="viewImage('${image.data}')"></div>`;
                    }
                });
                imagesHtml += '</div>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <img src="è®¾è®¡å›¾/æˆ‘çš„å¤´åƒ.png" alt="User" class="user-avatar-img">
                </div>
                <div class="message-content">
                    ${imagesHtml}
                    ${message ? `<div class="message-text">${escapeHtml(message)}</div>` : ''}
                    <div class="message-time">${getCurrentTime()}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ·»åŠ AIæ¶ˆæ¯
        function addAIMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ†æç»“æœï¼Œå¦‚æœæ˜¯åˆ™ä½¿ç”¨å¡ç‰‡æ ¼å¼
            const analysisData = parseAnalysisResult(message);
            
            if (analysisData) {
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <img src="è®¾è®¡å›¾/aiå¤´åƒ.png" alt="AI Assistant" class="ai-avatar-img">
                    </div>
                    <div class="message-content">
                        ${createAnalysisCards(analysisData)}
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                `;
            } else {
                // å¦‚æœæ²¡æœ‰è§£æåˆ°ç»“æ„åŒ–æ•°æ®ï¼Œå°è¯•å¼ºåˆ¶åˆ›å»ºå¡ç‰‡
                const fallbackData = {
                    difficulty: { complexity: 'Medium', score: 75, description: 'Pattern analysis completed with standard complexity assessment.' },
                    cost: { fabric: '$6.3-9.1/piece', trims: '$2.1-3.5/piece', pattern: '$112-168/style', sample: '$21-35/piece', total: '$141.4-215.6/style' },
                    suggestions: ['Create prototype sample to test design feasibility', 'Simplify complex construction elements', 'Use appropriate interfacing for stability']
                };
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <img src="è®¾è®¡å›¾/aiå¤´åƒ.png" alt="AI Assistant" class="ai-avatar-img">
                    </div>
                    <div class="message-content">
                        ${createAnalysisCards(fallbackData)}
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
            showActionButtons();
        }
        
        // è§£æåˆ†æç»“æœ
        function parseAnalysisResult(message) {
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«åˆ†æç»“æœçš„å…³é”®è¯
            if (message.includes('Pattern Risk Analysis') || 
                message.includes('COMPLEXITY ASSESSMENT') || 
                message.includes('POTENTIAL RISKS') ||
                message.includes('RECOMMENDATIONS') ||
                message.includes('Pattern Making Risk Assessment') ||
                message.includes('Main Risk Points') ||
                message.includes('Suggested Countermeasures')) {
                
                return {
                    difficulty: extractDifficultyInfo(message),
                    cost: extractCostInfo(message),
                    suggestions: extractSuggestions(message)
                };
            }
            return null;
        }
        
        // æå–éš¾åº¦ä¿¡æ¯
        function extractDifficultyInfo(message) {
            let complexity = 'Medium';
            let score = 75;
            let description = 'Pattern construction requires careful attention to fit and finishing details.';
            
            // æ£€æŸ¥ä¸­æ–‡å…³é”®è¯
            if (message.includes('é«˜') || message.includes('å¤æ‚') || message.includes('High') || message.includes('Complex')) {
                complexity = 'High';
                score = 85;
                description = 'High complexity due to advanced construction techniques and precise requirements.';
            } else if (message.includes('ä½') || message.includes('ç®€å•') || message.includes('Low') || message.includes('Simple')) {
                complexity = 'Low';
                score = 45;
                description = 'Simple construction with basic techniques and minimal requirements.';
            } else if (message.includes('ä¸­') || message.includes('ä¸­ç­‰') || message.includes('Medium')) {
                complexity = 'Medium';
                score = 65;
                description = 'Moderate complexity requiring standard construction techniques.';
            }
            
            return { complexity, score, description };
        }
        
        // æå–æˆæœ¬ä¿¡æ¯
        function extractCostInfo(message) {
            return {
                fabric: '$6.3-9.1/piece',
                trims: '$2.1-3.5/piece',
                pattern: '$112-168/style',
                sample: '$21-35/piece',
                total: '$141.4-215.6/style'
            };
        }
        
        // æå–å»ºè®®ä¿¡æ¯
        function extractSuggestions(message) {
            const suggestions = [];
            
            // æ£€æŸ¥ä¸­æ–‡å»ºè®®å…³é”®è¯
            if (message.includes('ç‰ˆå‹è°ƒæ•´') || message.includes('Pattern Adjustment')) {
                suggestions.push('Create 1:2 scale sample first to confirm silhouette ratio');
                suggestions.push('Control dropped shoulder angle between 23-25 degrees');
                suggestions.push('Widen armhole depth by 2-3cm for better mobility');
            }
            if (message.includes('å·¥è‰ºä¼˜åŒ–') || message.includes('Craftsmanship Optimization')) {
                suggestions.push('Simplify pocket design - Reduce decorative elements');
                suggestions.push('Standardize hardware - Use common size components');
                suggestions.push('Optimize stitching - Double needle for efficiency');
            }
            if (message.includes('é¢æ–™é£é™©') || message.includes('Fabric Risk')) {
                suggestions.push('Use stable fabrics to prevent wrinkling during sewing');
                suggestions.push('Test fabric elasticity before final construction');
                suggestions.push('Consider fabric weight and drape properties');
            }
            
            // é»˜è®¤å»ºè®®
            if (suggestions.length === 0) {
                suggestions.push('Create prototype sample to test design feasibility');
                suggestions.push('Simplify complex construction elements');
                suggestions.push('Use appropriate interfacing for stability');
                suggestions.push('Test fabric behavior before final construction');
            }
            
            return suggestions;
        }
        
        // åˆ›å»ºåˆ†æå¡ç‰‡HTML
        function createAnalysisCards(data) {
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' at ' + new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return `
                <div class="ai-guidance-section">
                    <div class="guidance-bubble">
                        The analysis has been completed for you. Here are the results.
                    </div>
                </div>
                <div class="analysis-result">
                    <div class="analysis-title">Analysis result</div>
                    <div class="analysis-date">${currentDate}</div>
                    
                    <div class="analysis-cards">
                        <!-- éš¾åº¦ç³»æ•°å¡ç‰‡ -->
                        <div class="analysis-card">
                            <div class="card-header">
                                <div class="card-title">Analysis of Difficulty Coefficient</div>
                                <div class="difficulty-score">${data.difficulty.score}</div>
                            </div>
                            <div class="card-content">
                                ${data.difficulty.description}
                            </div>
                        </div>
                        
                        <!-- æˆæœ¬ä¼°ç®—å¡ç‰‡ -->
                        <div class="analysis-card">
                            <div class="card-header">
                                <div class="card-title">Cost estimation</div>
                            </div>
                            <div class="card-content">
                                <div class="cost-item">
                                    <span>Fabric:</span>
                                    <span>${data.cost.fabric}</span>
                                </div>
                                <div class="cost-item">
                                    <span>Trims:</span>
                                    <span>${data.cost.trims}</span>
                                </div>
                                <div class="cost-item">
                                    <span>Pattern making:</span>
                                    <span>${data.cost.pattern}</span>
                                </div>
                                <div class="cost-item">
                                    <span>Sample:</span>
                                    <span>${data.cost.sample}</span>
                                </div>
                                <div class="cost-item cost-total">
                                    <span>Total:</span>
                                    <span>${data.cost.total}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¼˜åŒ–å»ºè®®å¡ç‰‡ -->
                        <div class="analysis-card">
                            <div class="card-header">
                                <div class="card-title">Suggestion on optimization</div>
                            </div>
                            <div class="card-content">
                                ${data.suggestions.map(suggestion => 
                                    `<div class="suggestion-item">${suggestion}</div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
        function showActionButtons() {
            const actionButtons = document.getElementById('actionButtons');
            
            if (actionButtons) {
                setTimeout(() => {
                    actionButtons.classList.add('show');
                }, 50); // å‡å°‘å»¶è¿Ÿåˆ°50ms
            }
        }

        // æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
        function showAIThinking(show = true) {
            const existingThinking = document.querySelector('.ai-thinking-message');
            if (existingThinking) {
                existingThinking.remove();
            }
            
            if (show) {
                const chatMessages = document.getElementById('chatMessages');
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'message ai-message ai-thinking-message';
                
                thinkingDiv.innerHTML = `
                    <div class="message-avatar">
                        <img src="è®¾è®¡å›¾/aiå¤´åƒ.png" alt="AI Assistant" class="ai-avatar-img">
                    </div>
                    <div class="message-content">
                        <div class="ai-thinking">
                            <span>Analyzing pattern...</span>
                            <div class="thinking-dots">
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(thinkingDiv);
                scrollToBottom();
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            setTimeout(() => {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50); // å‡å°‘å»¶è¿Ÿ
        }

        // è·å–å½“å‰æ—¶é—´
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç¡®ä¿è‹±æ–‡å›å¤
        function ensureEnglishResponse(text) {
            if (!text) return text;
            
            // ç§»é™¤ä¸­æ–‡å­—ç¬¦
            let cleanText = text.replace(/[\u4e00-\u9fff]/g, '').trim();
            
            // å¦‚æœæ¸…ç†åå†…å®¹å¤ªå°‘ï¼Œè¿”å›åŸæ–‡æœ¬ï¼ˆå¯èƒ½æœ¬æ¥å°±æ˜¯è‹±æ–‡ï¼‰
            if (cleanText.length < text.length * 0.5) {
                return text;
            }
            
            return cleanText || text;
        }

        // è·å–ä¸“ä¸šçš„æ‰“ç‰ˆåˆ†æå¤‡ç”¨å›å¤
        function getPatternAnalysisFallback(designDescription) {
            const lowerDesc = designDescription.toLowerCase();
            
            if (lowerDesc.includes('dress') || lowerDesc.includes('gown')) {
                return `Pattern Risk Analysis for Dress Design:

ğŸ” COMPLEXITY ASSESSMENT: Medium to High
â€¢ Dress patterns require precise fit calculations
â€¢ Consider bust, waist, and hip measurements carefully
â€¢ Allow extra seam allowance for adjustments

âš ï¸ POTENTIAL RISKS:
â€¢ Fit issues at bust and waist transition
â€¢ Hemline evenness challenges
â€¢ Zipper placement and alignment
â€¢ Fabric drape affecting silhouette

ğŸ’¡ RECOMMENDATIONS:
â€¢ Create a muslin prototype first
â€¢ Use stable fabrics for structured areas
â€¢ Consider bias cut for flowing sections
â€¢ Plan for multiple fittings
â€¢ Mark grain lines clearly on pattern pieces

ğŸ“ CONSTRUCTION NOTES:
â€¢ Start with basic bodice block
â€¢ Grade between sizes if needed
â€¢ Test closure methods on scraps
â€¢ Consider lining for complex designs`;
            }
            
            if (lowerDesc.includes('skirt')) {
                return `Pattern Risk Analysis for Skirt Design:

ğŸ” COMPLEXITY ASSESSMENT: Low to Medium
â€¢ Skirt patterns are generally straightforward
â€¢ Focus on waist fit and length proportions

âš ï¸ POTENTIAL RISKS:
â€¢ Waistband fit and comfort
â€¢ Hemline balance and evenness
â€¢ Pocket placement and reinforcement
â€¢ Closure stress points

ğŸ’¡ RECOMMENDATIONS:
â€¢ Ensure proper ease at waist and hips
â€¢ Use interfacing for waistband stability
â€¢ Consider A-line for forgiving fit
â€¢ Test hem techniques on fabric scraps
â€¢ Reinforce stress points at pockets

ğŸ“ CONSTRUCTION NOTES:
â€¢ Start with basic skirt block
â€¢ Adjust for desired silhouette
â€¢ Consider fabric stretch and drape
â€¢ Plan seam finishing methods`;
            }
            
            if (lowerDesc.includes('top') || lowerDesc.includes('blouse') || lowerDesc.includes('shirt')) {
                return `Pattern Risk Analysis for Top/Blouse Design:

ğŸ” COMPLEXITY ASSESSMENT: Medium
â€¢ Upper body fit requires precision
â€¢ Shoulder and armhole fit critical

âš ï¸ POTENTIAL RISKS:
â€¢ Shoulder seam placement
â€¢ Armhole comfort and mobility
â€¢ Neckline finishing challenges
â€¢ Sleeve attachment difficulties

ğŸ’¡ RECOMMENDATIONS:
â€¢ Perfect shoulder fit first
â€¢ Test armhole depth and width
â€¢ Consider ease for movement
â€¢ Plan neckline finishing method
â€¢ Use stay tape for stability

ğŸ“ CONSTRUCTION NOTES:
â€¢ Start with basic bodice block
â€¢ Adjust for design details
â€¢ Consider fabric behavior
â€¢ Plan construction sequence`;
            }
            
            // é€šç”¨åˆ†æ
            return `Pattern Risk Analysis for Garment Design:

ğŸ” COMPLEXITY ASSESSMENT: Medium
â€¢ Custom garment construction requires careful planning
â€¢ Pattern accuracy is crucial for professional results

âš ï¸ GENERAL RISKS:
â€¢ Fit and sizing challenges
â€¢ Fabric behavior unpredictability
â€¢ Construction sequence errors
â€¢ Finishing quality issues

ğŸ’¡ PROFESSIONAL RECOMMENDATIONS:
â€¢ Create detailed construction plan
â€¢ Test techniques on fabric scraps
â€¢ Make muslin prototype if complex
â€¢ Plan for multiple fittings
â€¢ Use appropriate interfacing and notions

ğŸ“ PATTERN DEVELOPMENT:
â€¢ Start with proven basic blocks
â€¢ Make gradual design modifications
â€¢ Document all changes for future reference
â€¢ Consider fabric stretch and drape properties
â€¢ Plan seam allowances and finishing methods

ğŸ¯ SUCCESS FACTORS:
â€¢ Accurate measurements and fit
â€¢ Quality construction techniques
â€¢ Appropriate fabric selection
â€¢ Professional finishing details`;
        }

        // å‘é€åˆ°AIè¿›è¡Œåˆ†æ - 5ç§’è¶…æ—¶åä½¿ç”¨æœ¬åœ°æ•°æ®
        async function sendToAI(message) {
            console.log('Sending pattern analysis request:', message);
            
            // æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
            showAIThinking(true);
            
            // è®¾ç½®5ç§’è¶…æ—¶
            const API_TIMEOUT = 5000;
            const minThinkingTime = 200;
            const startTime = Date.now();
            let hasResponded = false;
            
            // 5ç§’åè‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°æ•°æ®
            const fallbackTimer = setTimeout(() => {
                if (!hasResponded) {
                    console.log('API timeout, switching to local data');
                    hasResponded = true;
                    const fallbackResponse = getPatternAnalysisFallback(message);
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, minThinkingTime - elapsedTime);
                    
                    setTimeout(() => {
                        showAIThinking(false);
                        addAIMessage(fallbackResponse);
                    }, remainingTime + 10);
                }
            }, API_TIMEOUT);
            
            try {
                // å‡†å¤‡APIè¯·æ±‚æ•°æ®
                const requestData = {
                    design: message,
                    analysisType: 'pattern-risk',
                    language: 'en',
                    context: 'Fashion design pattern analysis. Please respond in English only.',
                    timestamp: new Date().toISOString()
                };
                
                console.log('API Request:', requestData);
                
                // åˆ›å»ºå¸¦è¶…æ—¶çš„fetchè¯·æ±‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);
                
                const response = await fetch(PATTERN_ANALYSIS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify(requestData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                clearTimeout(fallbackTimer);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                // æå–åˆ†æç»“æœ
                let analysisResult = data.analysis || 
                                   data.result || 
                                   data.response || 
                                   data.message || 
                                   data.output;
                
                // æ£€æŸ¥åµŒå¥—ç»“æ„
                if (!analysisResult && data.data) {
                    analysisResult = data.data.analysis || 
                                    data.data.result || 
                                    data.data.response;
                }
                
                if (!hasResponded) {
                    hasResponded = true;
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, minThinkingTime - elapsedTime);
                    
                    if (analysisResult) {
                        // ç¡®ä¿å›å¤æ˜¯è‹±æ–‡
                        analysisResult = ensureEnglishResponse(analysisResult);
                        
                        setTimeout(() => {
                            showAIThinking(false);
                            addAIMessage(analysisResult);
                        }, remainingTime + 10);
                    } else {
                        // ä½¿ç”¨ä¸“ä¸šçš„å¤‡ç”¨å›å¤
                        const fallbackResponse = getPatternAnalysisFallback(message);
                        setTimeout(() => {
                            showAIThinking(false);
                            addAIMessage(fallbackResponse);
                        }, remainingTime + 10);
                    }
                }
                
            } catch (error) {
                console.error('Pattern analysis API error:', error);
                clearTimeout(fallbackTimer);
                
                if (!hasResponded) {
                    hasResponded = true;
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, minThinkingTime - elapsedTime);
                    
                    // æä¾›ä¸“ä¸šçš„é”™è¯¯å›å¤
                    const fallbackResponse = getPatternAnalysisFallback(message);
                    setTimeout(() => {
                        showAIThinking(false);
                        addAIMessage(fallbackResponse);
                    }, remainingTime + 10);
                }
            }
        }

        // å‘é€åç»­æ¶ˆæ¯
        function sendFollowUpMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (message) {
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addUserMessage(message);
                
                // å‘é€åˆ°AI
                sendToAI(message);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                updateSendButtonState();
            }
        }
        
        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButtonState() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (input && sendButton) {
                if (input.value.trim()) {
                    sendButton.classList.add('active');
                } else {
                    sendButton.classList.remove('active');
                }
            }
        }
        
        // æŸ¥çœ‹å›¾ç‰‡
        function viewImage(imageSrc) {
            // åˆ›å»ºå…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            overlay.appendChild(img);
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }
        
        // æŒ‰é’®åŠŸèƒ½
        function collectResult() {
            alert('ğŸ’– Result collected! You can find it in your inspiration collection.');
        }
        
        function findSuppliers() {
            window.location.href = 'ä¾›è´§å•†.html';
        }
        
        function enterInspirationCollect() {
            window.location.href = 'çµæ„Ÿæ”¶é›†åˆ†æ1.html';
        }
        
        // æ·»åŠ æ›´å¤šå›¾ç‰‡åŠŸèƒ½
        function addMoreImages() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.multiple = true;
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å¤„ç†æ–°ä¸Šä¼ å›¾ç‰‡çš„é€»è¾‘
                    console.log('æ·»åŠ äº†æ–°å›¾ç‰‡:', files);
                    alert(`Added ${files.length} new image(s)!`);
                }
                // æ¸…ç†ä¸´æ—¶inputå…ƒç´ 
                document.body.removeChild(fileInput);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        // å¯¼èˆªåŠŸèƒ½
        function navigateToHome() {
            window.location.href = '../index.html';
        }
        
        function navigateToInspiration() {
            window.location.href = 'çµæ„Ÿæ¥æº.html';
        }
        
        function navigateToSupplier() {
            window.location.href = 'ä¾›è´§å•†.html';
        }
        
        function navigateToAccount() {
            window.location.href = 'ä¸ªäºº.html';
        }
        
        // é¡µé¢åŠ è½½æ—¶å¤„ç†URLå‚æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // æ–°çš„æ•°æ®æ ¼å¼å¤„ç†
            const dataParam = urlParams.get('data');
            if (dataParam) {
                try {
                    const data = JSON.parse(decodeURIComponent(dataParam));
                    
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆä¸åŒ…å«å›¾ç‰‡æ•°æ®ï¼‰
                    addUserMessage(data.design || '');
                    
                    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    if (data.hasImages && data.imageCount > 0) {
                        const chatMessages = document.getElementById('chatMessages');
                        const imageInfoDiv = document.createElement('div');
                        imageInfoDiv.className = 'message user-message';
                        imageInfoDiv.innerHTML = `
                            <div class="message-avatar">
                                <img src="è®¾è®¡å›¾/æˆ‘çš„å¤´åƒ.png" alt="User" class="user-avatar-img">
                            </div>
                            <div class="message-content">
                                <div class="message-text">ğŸ“· Uploaded ${data.imageCount} image(s) for analysis</div>
                                <div class="message-time">${getCurrentTime()}</div>
                            </div>
                        `;
                        chatMessages.appendChild(imageInfoDiv);
                    }
                    
                    // ç«‹å³æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€å¹¶å‘é€åˆ°AIè¿›è¡Œåˆ†æ
                    setTimeout(() => {
                        sendToAI(data.design || 'Analyze the uploaded design');
                    }, 50);
                } catch (error) {
                    console.error('Error parsing data:', error);
                }
            } else {
                // å…¼å®¹æ—§çš„æ ¼å¼
                const design = urlParams.get('design');
                if (design) {
                    addUserMessage(decodeURIComponent(design));
                    setTimeout(() => {
                        sendToAI(decodeURIComponent(design));
                    }, 50);
                }
            }
            
            // è®¾ç½®è¾“å…¥æ¡†äº‹ä»¶
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', updateSendButtonState);
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendFollowUpMessage();
                    }
                });
            }
            
            console.log('Pattern Analysis Results page loaded');
        });
    </script>
</body>
</html>
